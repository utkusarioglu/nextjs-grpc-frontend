name: Build & test and Push

on:
  workflow_call:

jobs:
  build-android:
    secrets: inherit
    uses: ./.github/workflows/android.build.wfc.yml

  build-web:
    uses: ./.github/workflows/web.build.wfc.yml
    secrets: inherit
    with:
      ref: ${{ github.ref_name }}

  test-web-server-endpoints:
    uses: ./.github/workflows/web-server-endpoints.test.wfc.yml
    secrets: inherit
    needs:
      - build-web
    with:
      ref: ${{ github.ref_name }}

  create-variables:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.create-variables.outputs.image_tag }}
    steps:
      - id: create-variables
        run: |
          repo_tag="${{ github.ref_name }}"
          image_tag="${repo_tag//\//-}"
          echo "image tag is: $image_tag"
          echo "image_tag=$image_tag" >> "$GITHUB_OUTPUT"

  test-k8s-integration:
    uses: utkusarioglu/nextjs-grpc-infra/.github/workflows/k3d-dev-local.test.wfc.yml@experiment/test/workflow-calls
    secrets: inherit
    needs:
      - test-web-server-endpoints
      - create-variables
    with:
      frontendRef: ${{ github.ref_name }}
      infraRef: experiment/test/workflow-calls

      webServerImageTag: ${{ needs.create-variables.outputs.image_tag }}
      # msImageTag: "bbb"
