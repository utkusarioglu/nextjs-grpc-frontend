name: Build Web Server

on:
  push:
    tags:
      - "**.**.**"
      - "experiment/**/**/**"
    paths:
      - apps/**
      - packages/**
      - .github/workflows/build-web.yml
  pull_request:
    types:
      - opened
      - reopened
      - edited
      - synchronize
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # build-and-push:
  #   name: build-and-push
  #   uses: ./.github/workflows/build-web-call.yml
  #   secrets: inherit
  #   with:
  #     ref: ${{ github.ref_name }}

  # test-web-server-endpoints:
  #   name: test-web-server-endpoints
  #   uses: ./.github/workflows/test-web-server-endpoints-call.yml
  #   secrets: inherit
  #   needs:
  #     - build-and-push
  #   with:
  #     ref: ${{ github.ref_name }}

  create-variables:
    name: create-variables
    outputs:
      image_tag: ${{ steps.create-variables.outputs.image_tag }}
    steps:
      - name: create-variables
        run: |
          repo_tag="${{ github.ref_name }}"
          image_tag="${repo_tag//\//-}"
          echo "image tag is: $image_tag"
          echo "image_tag=${image_tag}" >> $GITHUB_OUTPUT

  test-web-integration:
    name: infra-test-web
    uses: utkusarioglu/nextjs-grpc-infra/.github/workflows/test-k3d-dev-local-call.yml@experiment/test/workflow-calls
    secrets: inherit
    needs:
      # - test-web-server-endpoints
      - create-variables
    with:
      frontend: ${{ github.ref_name }}
      infra: experiment/test/workflow-calls
      webServerImageTag: ${{ jobs.create-variables.outputs.image_tag }}
